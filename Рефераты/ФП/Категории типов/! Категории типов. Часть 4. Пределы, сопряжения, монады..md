Итак, позади три вводные части  обзора, в которых мы познакомились с категориями, функторами между ними, а также естественными преобразованиями для функторов. В данной же части мы увидим, как все эти понятия помогут нам разобраться, какие вообще есть инструменты для конструирования новых типов. Мы получим представление, откуда берутся *монады* (наконец то!) и выясним, почему их так сложно композировать.
# Мотивация

В одной из предыдущих частей обзора [был продемонстрирован](https://habr.com/ru/articles/933016/#anyfunctor) функтор, связывающий две разные категории одного и того же объекта — категории типов $\star$. Только в начальной категории морфизмами выступали конструкторы типов `F[_]`, а в конечной — эндофункторы `Functor[F]`. Полученный функтор сохранял композицию конструкторов типов, позволяя из любых `Functor[F]` и `Functor[G]` создавать `Functor[G ∘ F]`. А это, в свою очередь, означает, что если имеются реализации эндофункторов для каких-либо *базовых* `F[_]`, у нас автоматически есть эндофункоры для абсолютно любых `F[_]`!

Открытым остаётся вопрос, какие конструкторы типов можно считать настолько «базовыми», что композируя их, можно получить вообще всё. Во многих публикациях данного цикла обзоров неоднократно упоминалось об алгебраической природе типов, о том, что в основе всего лежат элементарные математические операции — сумма, произведение и экпоненциал (а также понятия нуля и единицы). Однако, мне приходилось всячески избегать объяснения, *почему* происходит именно так. Дело в том, что ключ к понимаю этого лежит в теории категорий, так что только сейчас настало время разобраться с этим вопросом.

В первом обзоре цикла [упоминалось](https://habr.com/ru/articles/758542/#types), что любой тип можно определить через его *универсальное свойство*. Это понятие заимствовано из теории категории, с его помощью формулируются новые конструкции в категориях. Поэтому сперва давайте разберёмся, как это работает.

# Универсальные свойства

В качестве примера напомню универсальное свойство произведения объектов:
> произведением двух объектов $A$ и $B$ выбранной категории называется такой объект $A \times B$ с морфизмами $p_A: A \times B \rightarrow A$ и $p_B: A \times B \rightarrow B$, что для любых объекта $C$ и морфизмов $f: C \rightarrow A$ и $g: C \rightarrow B$ будет существовать единственный морфизм $u: C \rightarrow A \times B$, делающий такую диаграмму коммутирующей:


 ![[произведение типов.png|600]]

Определяемый объект $A \times B$, также как и все кандидаты $C$, имеют аналогичную пару морфизмов, идущих от них к $A$ и $B$. Но среди всех кандидатов выделяется лишь один универсальный объект $A \times B$ — его *универсальный морфизм* $u$ будет единственным *для любого* другого кандидата. Все остальные кандидаты будут либо сложнее (например, морфизм $A \times B \rightarrow A \times B \times X$ будет не единственным), либо диаграмма не будет коммутировать (по сути, любой кандидат, но выбранные для него морфизмы $f$ и $g$ не полиморфны по $A$, или $B$).

Определение любого универсального свойства в категории имеет такую структуру:
- обозначаются объекты, *через которые формулируется* универсальный (для произведения и суммы — это просто пара объектов $A, B$);
- выбирается семейство кандидатов с определёнными возможностями (в примере выше — пары морфизмов $f, g$ или $p_A, p_B$);
- для каждого кандидата определяется морфизм $u$, связывающий его с целевым универсальным объектом;
- такой морфизм обязан быть единственным и обеспечивающий коммутируемость полученной диаграммы.

Как перечисленные пункты описать в терминах категории типов? «Возможности» кандидата — это некие преобразования, связывающие его с объектами подкатегории, фиксирующими формулировку универсального свойства. А требование коммутируеммости диаграммы очень напоминает условие *естественности* этого преобразования!

Конечно же, тут подразумевается некая функториальность для конструктора типов `F[_, ...]`. Его параметры даже могут иметь разную вариантность, поэтому в общем случае придётся иметь дело с *мультипрофункторами*, но в этой статье мы будем иметь дело, в первую очередь, с ковариантными функторами и бифункторами.


# Конусы и ко-конусы

Давайте сперва посмотрим, как универсальные свойства выражаются с помощью естественных преобразований в некоторой категории $\mathcal{C}$. Объекты, через которые формулируется универсальный объект, образуют подкатегорию в $\mathcal{C}$. Для произведения объектов $a$ и $b$ такая подкатегория будет дискретной, содержащей только эти два объекта и их тождественные морфизмы. Но в случае других универсальных свойств устройство подкатегории может быть и сложнее.

Выбор конкретной подкатегории в $\mathcal{C}$ удобно выразить с помощью функтора, встраивающего в $\mathcal{C}$ некую модельную категорию $\mathcal{I}$. В случае универсального свойства произведения это и будет дискретная категория двух индексов, скажем, $1$ и $2$. Тогда функтор $F_{ab}: \mathcal{I} \rightarrow \mathcal{C}$ и будет отвечать за выбор конкретных $a$ и $b$ в $\mathcal{C}$.

Технически, сейчас можно было бы и обойтись без введения модельной категории и функтора из неё. Но кажется, что не значительно усложняя, мы только приобретём в наглядности рассуждений. Кроме того, такая точка зрения ещё пригодится нам в дальнейшем, поэтому полезно привыкнуть к ней заранее.

Ещё нам нужно выбрать объект-кандидат . Поручим это **константному функтору** $\Delta\,c: \mathcal{I} \rightarrow \mathcal{C}$. Тогда естественное преобразование $\Delta\,c \rightsquigarrow F$ называется **конусом** функтора :
$$
Cone(F,c): \Delta c \leadsto F
$$
Компоненты конуса индексированы объектами моделирующей категории $\mathcal{I}$. Например, для произведения типов это будут две компоненты
$$
\begin{split}
Cone(F_{ab},c)_1&: c \rightarrow a,\\
Cone(F_{ab},c)_2&: c \rightarrow b
\end{split}
$$
Естественность преобразования нужна для случаев, когда в модельной категории $\mathcal{I}$ есть другие морфизмы помимо тождественных (например, $1 \rightarrow 2$), и функтор $F$ переносит их в также нетождественные морфизмы ($a \rightarrow b$). Тогда конус *обязан* быть естественным по отношению к этому функтору (в связке с константным, который погоды не делает).

Образ функтора $F$ образует подкатегорию $F\, \mathcal{I} \subset \mathcal{C}$, являющуюся «основанием» этого конуса, а объект $c: \mathcal{C}$ будет его вершиной:
### !!! Рисунок конуса !!!

Для универсального свойства суммы объектов получим дуальную картину. Напомню,
> суммой двух объектов $A$ и $B$ выбранной категории называется такой объект $A + B$ с морфизмами $i_A: A \rightarrow A + B$ и $i_B: B \rightarrow A + B$, что для любых объекта $D$ и морфизмов $f: A \rightarrow D$ и $g: B \rightarrow D$ будет существовать единственный морфизм $u: A + B \rightarrow D$, делающий такую диаграмму коммутирующей:

![[сумма типов.png|600]]

В сравнении с произведением, объекты на диаграмме сохранили своё положение, но все морфизмы оказались обращены. Кандидаты в сумму объектов описываются дуальной конструкцией, называемой **ко-конусом**:
$$
Cocon(F,c): F \rightsquigarrow \Delta c
$$
На диаграмме получаем как бы «перевёрнутый конус»:
### !!! Рисунок коконуса !!!

Обратите внимание, что и моделирующая категория $\mathcal{I}$ и функтор $F$ остались теми же, что и для произведения типов! Изменилось только направление естественного преобразования.

### !! намёк на фундаментальность суммы и произведения 

Кандидаты в любые универсальные объекты можно выразить либо через конусы, либо ко-конусы. Осталось только найти среди них *тот самый универсальный* (если он вообще есть).


# Пределы и ко-пределы

«…для каждого кандидата существует единственный морфизм, делающий диаграмму коммутирующей.»

…тут важно  прочувствовать очень тонкий момент (как формулируется условие единственности через естественный изоморфизм hom-типов)

https://bartoszmilewski.com/2015/04/15/limits-and-colimits/
https://bartoszmilewski.com/2014/05/05/understanding-products-and-universal-constructions/
https://bartoszmilewski.com/2014/05/08/understanding-limits-2/

Многие универсальные конструкции, такие как пределы, можно охарактеризовать через представимость предпучков.  Например, пусть F : J -> C - функтор.  Рассмотрим предпучок конусов Cone(-, F) : C^op -> Set, который отображает объект X в множество конусов из X в F.  Предел lim F существует тогда и только тогда, когда Cone(-, F) представим.  Представляющий объект будет самим пределом, а универсальный элемент – предельным конусом.

# Сопряжения функторов

[Whenever you see a natural isomorphism of hom sets, chances are there is an adjunction between two functors](https://www.google.com/search?q=Whenever+you+see+a+natural+isomorphism+of+hom+sets,+chances+are+there+is+an+adjunction+between+two+functors&deb=0mobile1gsa&hl=ru&uuld=51.62926,39.102055&ctxsl_trans=1&tlitetxt=Whenever+you+see+a+natural+isomorphism+of+hom+sets,+chances+are+there+is+an+adjunction+between+two+functors&tlitesl=en&tlitetl=ru&ctxr)

[The main difference between universal constructions and adjunctions is that the latter are defined globally — for all hom-sets](https://bartoszmilewski.com/2016/04/18/adjunctions/#:~:text=The%20main%20difference%20between%20universal%20constructions%20and%20adjunctions%20is%20that%20the%20latter%20are%20defined%20globally%20%E2%80%94%20for%20all%20hom-sets)


Существование сопряженных функторов тесно связано с существованием пределов и колимитов. Теория предпучков может помочь в понимании условий существования сопряженных функторов и их свойств.


# Монады

## моноид и моноидальная категория.

Это два разных, хотя и связанных, понятия в теории категорий. Важно понимать разницу между ними, чтобы не путать их.

1. Моноид в теории категорий

•  Где: Моноид определяется внутри некоторой моноидальной категории (обычно, но не всегда, это категория множеств Set с декартовым произведением в качестве тензорного произведения).
•  Что: Это объект M вместе с двумя морфизмами:
  •  μ: M ⊗ M → M (операция "умножения" или "композиции").
  •  η: I → M (морфизм из единичного объекта в M, определяющий "единичный элемент").

  где I — единичный объект моноидальной категории (например, одноэлементное множество {} в категории Set). ⊗ - это тензорное произведение в моноидальной категории.

•  Свойства: Эти морфизмы должны удовлетворять двум аксиомам, выражающим ассоциативность и единичность:
  •  Ассоциативность: μ ∘ (μ ⊗ id_M) = μ ∘ (id_M ⊗ μ) : M ⊗ M ⊗ M → M
  •  Единица: μ ∘ (η ⊗ id_M) = λ : I ⊗ M → M и μ ∘ (id_M ⊗ η) = ρ : M ⊗ I → M (где λ и ρ - левый и правый униторы моноидальной категории).

•  Пример (в категории множеств Set):
  •  M — множество (например, множество строк).
  •  μ — функция M × M → M (например, конкатенация строк).
  •  η — функция {} → M (выбирающая пустую строку).

  Это обычный моноид, как мы его знаем в алгебре.

•  Другие примеры:
  •  Моноид в категории эндофункторов — это монада.
  •  Группа — это моноид с дополнительным условием существования обратного элемента.

2. Моноидальная категория

•  Что: Это сама категория с дополнительной структурой, а именно:
  •  Тензорное произведение: Бифунктор ⊗ : C × C → C, который позволяет "умножать" два объекта категории C и получать новый объект той же категории.
  •  Единичный объект: Объект I в категории C, который является "единицей" для тензорного произведения.
  •  Ассоциатор: Естественный изоморфизм α_{A,B,C} : (A ⊗ B) ⊗ C → A ⊗ (B ⊗ C), который выражает ассоциативность тензорного произведения (с точностью до изоморфизма).
  •  Левый и правый униторы: Естественные изоморфизмы λ_A : I ⊗ A → A и ρ_A : A ⊗ I → A, которые показывают, как единичный объект взаимодействует с тензорным произведением.

•  Свойства: Ассоциатор и униторы должны удовлетворять определённым аксиомам когерентности (например, пентагональная аксиома и треугольная аксиома), чтобы обеспечить согласованность операций.

•  Примеры:
  •  Категория множеств Set с декартовым произведением × в качестве тензорного произведения и одноэлементным множеством {} в качестве единичного объекта.
  •  Категория векторных пространств Vect с тензорным произведением векторных пространств и полем k (рассматриваемым как 1-мерное векторное пространство) в качестве единичного объекта.
  •  Категория категорий Cat с декартовым произведением категорий и тривиальной категорией в качестве единичного объекта.

Главное отличие:

•  Моноидальная категория — это тип категории, вид категории, которая обладает дополнительной структурой (тензорным произведением и единичным объектом). Она является фундаментом для определения моноидов.

•  Моноид (в теории категорий) — это объект внутри уже существующей моноидальной категории, который удовлетворяет определённым условиям (ассоциативность и единичность). Он является конкретным элементом с определёнными свойствами.

Аналогия:

Представь себе:

•  Моноидальная категория — это кухня. На кухне есть стол (тензорное произведение), место для хранения продуктов (объекты) и рецепты (правила когерентности).
•  Моноид (в теории категорий) — это конкретный рецепт пирога (объект), который ты можешь приготовить на этой к

ухне. У пирога есть ингредиенты (элементы объекта) и способ их смешивания (операция умножения).

В итоге:

Моноидальная категория — это структура, в которой можно определять моноиды. Моноид — это конкретный объект, удовлетворяющий определённым условиям, внутри моноидальной категории.
