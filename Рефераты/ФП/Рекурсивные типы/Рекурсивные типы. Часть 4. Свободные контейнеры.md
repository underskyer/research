

<anchor>free</anchor>

#### –°–≤–æ–±–æ–¥–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

–í—ã—à–µ –±—ã–ª–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –æ–±—â–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞ –Ω–µ–ø–æ–¥–≤–∏–∂–Ω—ã—Ö —Ç–æ—á–µ–∫, –ø—Ä–∏–º–µ–Ω—è–µ–º—ã—Ö –∫ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–º –∫–æ–≤–∞—Ä–∏–∞–Ω—Ç–Ω—ã–º –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞–º —Ç–∏–ø–æ–≤ –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ. –ó–¥–µ—Å—å —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º —á—É—Ç—å –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã–µ –Ω–µ–ø–æ–¥–≤–∏–∂–Ω—ã–µ —Ç–æ—á–∫–∏, –∫–æ–≥–¥–∞ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π —Ü–µ–ª–µ–≤–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –æ–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è –≤ –¥—Ä—É–≥—É—é –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—é.

–ù–µ–ø–æ–¥–≤–∏–∂–Ω–∞—è —Ç–æ—á–∫–∞, –ø—Ä–∏–Ω–∏–º–∞—è –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Ç–∏–ø–æ–≤, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–æ—Å—Ç–æ–π —Ç–∏–ø ‚Äì –∫–∞–∫ –±—ã ¬´–ø–æ–Ω–∏–∂–∞–µ—Ç –∞—Ä–Ω–æ—Å—Ç—å¬ª. –ï—Å–ª–∏ –∂–µ ¬´–ø–æ–≤—ã—Å–∏—Ç—å –∞—Ä–Ω–æ—Å—Ç—å¬ª –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–≤ –µ–≥–æ –≤ –≤—ã—Ä–∞–∂–µ–Ω–∏–∏ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º —Å–≤–æ–±–æ–¥–Ω—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º, —Ç–æ –Ω–µ–ø–æ–¥–≤–∏–∂–Ω–∞—è —Ç–æ—á–∫–∞ –∫–∞–∫ –±—ã ¬´–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç –∞—Ä–Ω–æ—Å—Ç—å¬ª, —Ñ–æ—Ä–º–∏—Ä—É—è —Ç–µ–º —Å–∞–º—ã–º –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω–æ–≥–æ —Ç–∏–ø–∞ –≤ –Ω–µ–∫–∏–π –¥—Ä—É–≥–æ–π. –†–∞—Å—Å–º–æ—Ç—Ä–∏–º —Ç–∞–∫–æ–π –ø—Ä–∏–º–µ—Ä:
```scala
type CoEnv[E, F[_]] = [X] =>> E Either F[X]  // —É—Å—Ç–æ—è–≤—à–µ–µ—Å—è –Ω–∞–∑–≤–∞–Ω–∏–µ
```
–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Ç–∏–ø–æ–≤ `CoEnv` –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∏—Ä–æ–≤–∞–Ω –ø–æ–º–∏–º–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω–æ–≥–æ `F[_]` –µ—â—ë –¥–≤—É–º—è –ø—Ä–æ—Å—Ç—ã–º–∏ —Ç–∏–ø–∞–º–∏ `E` –∏ `X`. ¬´–£–Ω–∞—Ä–Ω—ã–π¬ª `F[_]` –æ–Ω –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –≤ ¬´–±–∏–Ω–∞—Ä–Ω—ã–π¬ª `ConEnv[_, F][_]`, –Ω–µ–ø–æ–¥–≤–∏–∂–Ω–æ–π —Ç–æ—á–Ω–æ–π –∫–æ—Ç–æ—Ä–æ–≥–æ –±—É–¥–µ—Ç —Å–Ω–æ–≤–∞ ¬´—É–Ω–∞—Ä–Ω—ã–π¬ª –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä:
```scala
type Free[F[_]] = [A] =>> Œº[CoEnv[A, F]] // A Either F[Free[F, A]]
```
–í–≤–∏–¥—É –∫–æ–≤–∞—Ä–∏–∞–Ω—Ç–Ω–æ—Å—Ç–∏ `F[_]` –∏ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ —Å–≤–æ–π—Å—Ç–≤–∞ —Å—É–º–º—ã —Ç–∏–ø–æ–≤, –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä `Free[F][_]` –º–æ–∂–Ω–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å –≤ –≤–∏–¥–µ —Ç–∞–∫–æ–π –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–π —Å—É–º–º—ã:

$$
Free[F][A] = A + F[A + F[A + \ldots]] \cong A + F[A] + F[F[A]] + \ldots
$$

–ù–µ —Å–ª–æ–∂–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä `Free[F][_]` —Ç–∞–∫–∂–µ —è–≤–ª—è–µ—Ç—Å—è –∫–æ–≤–∞—Ä–∏–∞–Ω—Ç–Ω—ã–º:
```scala
given liftForCoenv[F[_]: Lift, A]: Lift[CoEnv[A, F]] =
  [X, Y] => (f: X => Y) => (fx: CoEnv[A, F][X]) => fx.map(_ map f)

given liftForFree[F[_]: Lift]: Lift[Free[F]] =
  [A, B] => (f: A => B) => (fa: Free[F][A]) =>
    inFix[Œº, CoEnv[B, F]](
      outFix[Œº, CoEnv[A, F]](fa)
        .left .map(                   f  )
        .right.map(fmap(fmap[Free[F]](f)))
    )
```

 –£ –Ω–∞—Å –µ—Å—Ç—å –¥–≤–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ –¥–ª—è `Free`:
```scala
def pureFree[F[_]: Lift] = [A] => ( a:           A  ) => inFix[Œº, CoEnv[A, F]](Left ( a))
def bindFree[F[_]: Lift] = [A] => (fa: F[Free[F][A]]) => inFix[Œº, CoEnv[A, F]](Right(fa))
```
–ß–∏—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –º–æ–∂–Ω–æ ¬´–æ—Å–≤–æ–±–æ–¥–∏—Ç—å¬ª —Å –ø–æ–º–æ—â—å—é `pureFree`,  –∞ –∑–∞–ø–∞–∫–æ–≤–∞–Ω–Ω—ã–µ –≤ `F[_]` ‚Äì ¬´–ø–æ–¥–Ω—è—Ç—å –≤ —Å–≤–æ–±–æ–¥–Ω—ã–π –º–∏—Ä¬ª –ø–æ—Å—Ä–µ–¥—Å—Ç–≤–æ–º `liftFree`:
```scala
def liftFree[F[_]: Lift] = [A] => (fa: F[A ]) => bindFree[F][A](fa map pureFree[F][A])
```

–†–∞—Å–ø–∞–∫–æ–≤–∫–∞ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ ‚Äì —ç—Ç–æ –æ–±—ã—á–Ω–∞—è —Å–≤—ë—Ä—Ç–∫–∞:
```scala
def convertAlgebra[F[_]: Lift, A]: Algebra[F][A] => Algebra[CoEnv[A, F]][A] =
  alg => {_.fold(identity, alg)}

def goFree[F[_]: Lift, A]: Algebra[F][A] => Algebra[Free[F]][A] =
  convertAlgebra[F, A] andThen foldFix[Œº][CoEnv[A, F]][A]

val freeVal: Free[Option][Int] = liftFree(Option(42))
goFree[Option, Int](_.get)(freeVal) // 42: Int
```

–°–∞–º–æ–π –∂–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–π –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é `Free[F]` —è–≤–ª—è–µ—Ç—Å—è ¬´—Ä–∞–∑–º–∞—Ç—Ä—ë—à–∏–≤–∞–Ω–∏–µ¬ª –¥–ª—è *–ª—é–±–æ–≥–æ* –∫–æ–≤–∞—Ä–∏–∞–Ω—Ç–Ω–æ–≥–æ `F[_]`:
```scala
def flattenFree[F[_]: Lift, A]: Free[F][Free[F][A]] => Free[F][A] =
  foldFix[Œº][CoEnv[Free[F][A], F]](_.fold(identity, bindFree[F][A]))


given freeMonad[F[_]: Lift]: Monad[Free[F]] = Monad[Free[F]](
  pure    = pureFree,
  flatten = [X] => (ffx: Free[F][Free[F][X]]) => flattenFree(ffx)
)
```

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –∏–∑ ¬´—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã—Ö¬ª —Ñ—É–Ω–∫—Ü–∏–π –≤–∏–¥–∞ `A => F[B]`, –≤—Å–µ–≥–¥–∞ –º–æ–∂–Ω–æ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å —Ü–µ–ø–æ—á–∫—É –≤—ã—á–∏—Å–ª–µ–Ω–∏–π, –¥–∞–∂–µ –µ—Å–ª–∏ –¥–ª—è `F[_]` –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ ¬´—Ä–∞–∑–º–∞—Ç—Ä—ë—à–∏–≤–∞–Ω–∏–µ¬ª! –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–π ¬´–ø–æ–¥–Ω–∏–º–∞—Ç—å¬ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç `F[X]` –¥–æ `Free[F][X]`, –∫–æ–º–ø–æ–∑–∏—Ä–æ–≤–∞—Ç—å –≤—ã—á–∏—Å–ª–µ–Ω–∏—è, –ø–æ—Å—Ä–µ–¥—Å—Ç–≤–æ–º `liftFree` –∏ `freeMonad` (`flatMap`), –≤ –∏—Ç–æ–≥–µ –ø–æ–ª—É—á–∞—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç `Free[F][Result]`. –ò —Ç–æ–ª—å–∫–æ –≤ —Å–∞–º–æ–º –∫–æ–Ω—Ü–µ, –ø—Ä–∏ —Ä–∞—Å–ø–∞–∫–æ–≤–∫–µ, –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è F-–∞–ª–≥–µ–±—Ä–∞ `F[Result] => Result`.

- nLab - –∫—Ä—É—Ç–æ, –Ω–æ —Å–ª–æ–∂–Ω–æ–≤–∞—Ç–æ [transfinite construction of free algebras](https://ncatlab.org/nlab/show/transfinite+construction+of+free+algebras)





<anchor>freer</anchor>

#### –ë–æ–ª–µ–µ —Å–≤–æ–±–æ–¥–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

–î–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º `Free[F][_]` —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ –∫–æ–≤–∞—Ä–∏–∞–Ω—Ç–Ω–æ—Å—Ç–∏ `F[_]`, –∫–æ—Ç–æ—Ä–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –º–µ—Ç–æ–¥–∞ `map`. –ë–æ–ª—å—à–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –¥–∞—ë—Ç ¬´–±–æ–ª–µ–µ —Å–≤–æ–±–æ–¥–Ω—ã–π¬ª –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä `Freer[F][_]` –¥–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ –∫–æ–≤–∞—Ä–∏–∞–Ω—Ç–Ω–æ—Å—Ç—å `F[_]` –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞:
```scala
enum   Freer  [F[_], A]:
  case Pure   [F[_], A]   (a: A)                                   extends Freer[F, A]
  case Suspend[F[_], A]   (a: F[Freer[F, A]])                      extends Freer[F, A]
  case FlatMap[F[_], A, B](fb: Freer[F, B], afb: B => Freer[F, A]) extends Freer[F, A]

extension [F[_], A](ffa: Freer[F, A])
  def map    [B](f: A =>          B ): Freer[F, B] = Freer.FlatMap(ffa, f andThen Pure.apply)
  def flatMap[B](f: A => Freer[F, B]): Freer[F, B] = Freer.FlatMap(ffa, f                   )
```
–î–ª—è –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–π —Ç–µ–ø–µ—Ä—å –≤–æ–æ–±—â–µ –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è –Ω–∏–∫–∞–∫–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ `F[_]`!

–ü—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å `Freer[F][_]` –≤ –≤–∏–¥–µ –Ω–µ–ø–æ–¥–≤–∏–∂–Ω–æ–π —Ç–æ—á–∫–∏ –∫–∞–∫–æ–≥–æ-–ª–∏–±–æ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ —Ç–∏–ø–æ–≤ –æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –Ω–µ —Ç–∞–∫-—Ç–æ –ø—Ä–æ—Å—Ç–æ‚Ä¶ –î–µ–ª–æ –≤ —Ç–æ–º, —á—Ç–æ –∏–∑-–∑–∞ `FlatMap[F[_], A, B]` —ç—Ç–æ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π *—Å–ø–∏—Å–æ–∫ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–π*, –ø—Ä–∏—á—ë–º –∫–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç —ç—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞ *—Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω –ø–æ-—Å–≤–æ–µ–º—É*. –¢–∞–∫–æ–π —Ä–∞–∑–Ω–æ—Ä–æ–¥–Ω—ã–π —Å–ø–∏—Å–æ–∫ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ —á–∞—Å—Ç–Ω–æ–º—É —Å–ª—É—á–∞—é *–∑–∞–≤–∏—Å–∏–º—ã—Ö —Ç–∏–ø–æ–≤*, –∞ —ç—Ç–∞ —Ç–µ–º–∞ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ —Ä–∞–º–∫–∏ –¥–∞–Ω–Ω–æ–π —Å—Ç–∞—Ç—å–∏.

–¢–µ–º –Ω–µ –º–µ–Ω–µ–µ, `Freer[F][_]` –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –∑–∞–º–µ—á–∞—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏. –° –Ω–∏–º –º–æ–∂–Ω–æ –æ–ø–∏—Å–∞—Ç—å –±–∏–∑–Ω–µ—Å-—ç—Ñ—Ñ–µ–∫—Ç—ã –∫–∞–∫ *–æ–±–æ–±—â—ë–Ω–Ω—ã–µ –∞–ª–≥–µ–±—Ä–∞–∏—á–µ—Å–∫–∏–µ —Ç–∏–ø—ã* (GADT) –≤–∏–¥–∞ `SomeBuisenessEffect[_]`, –∏ —Å–∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å –∏—Ö –ø–æ—Å—Ä–µ–¥—Å—Ç–≤–æ–º `Freer`, –ø–æ–ª—É—á–∞—è *–ø—Ä–æ–≥—Ä–∞–º–º—É-–∫–∞–∫-–¥–∞–Ω–Ω—ã–µ* ‚Äì —Ç—É —Å–∞–º—É—é –ª–µ–Ω–∏–≤—É—é –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤—ã—á–∏—Å–ª–µ–Ω–∏–π. –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è —Ç–∞–∫–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è *–≤ —Å–∞–º–æ–º –∫–æ–Ω—Ü–µ* –≤ –ª—é–±–æ–π —É–¥–æ–±–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ `G[_]`, –µ—Å–ª–∏ –¥–ª—è –Ω–µ–≥–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã –º–æ–Ω–∞–¥–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏ ¬´–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ¬ª `SomeBuisenessEffect ~> G`:
```scala
extension [F[_], A](ffa: Freer[F, A])
  def foldMap[G[_]: Monad](interprete: F ~> G): G[A] = ffa match
    case Return(a)      => Monad[G].pure(a)
    case Suspend(ma)    => interprete(ma).flatMap(_ foldMap interprete)
    case FlatMap(fa, f) => fa.foldMap(interprete).flatMap(f(_) foldMap interprete)
```

–ë–æ–ª—å—à–µ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π, –∞ —Ç–∞–∫–∂–µ –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç–∞–∫–∏—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ [–≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Å—Ç–∞—Ç—å–µ](https://habr.com/ru/articles/807495/#free). –í –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —É–ø–æ–º—è–Ω—É—Ç—ã—Ö —Ç–∞–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Ä–µ–∫–æ–º–µ–Ω–¥—É—é —Ç–∞–∫–∂–µ [—ç—Ç—É –ø–æ–¥–±–æ—Ä–∫—É —Å—Å—ã–ª–æ–∫](https://github.com/mtumilowicz/scala-cats-free-monad-workshop).

¬´–ë–æ–ª–µ–µ —Å–≤–æ–±–æ–¥–Ω—ã–π¬ª –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è, –Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ö [Cats](https://typelevel.org/cats/datatypes/freemonad.html) –∏ [Scalaz](https://eed3si9n.com/learning-scalaz/Free+Monad.html) –≤ –ø–æ–¥ –∏–º–µ–Ω–µ–º `Free`. –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –Ω–∞ –µ–≥–æ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ–≥—Ä–∞–º–º–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ —Ç—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ–º (–∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–µ–π) ¬´—Å–≤–æ–±–æ–¥–Ω–æ–π¬ª –ø—Ä–æ–≥—Ä–∞–º–º—ã —Å–ø–µ—Ä–≤–∞ —Å–æ–±—Ä–∞—Ç—å —ç—Ç—É —Å–∞–º—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É –∫–∞–∫ –Ω–µ–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ. –≠—Ç–æ—Ç ¬´–ª–∏—à–Ω–∏–π —à–∞–≥¬ª –≤–ª–µ—á—ë—Ç –Ω–µ —Ç–æ —á—Ç–æ–±—ã –±–æ–ª—å—à–∏–µ, –Ω–æ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∏–∑–¥–µ—Ä–∂–∫–∏ –ø–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –ø–æ—ç—Ç–æ–º—É —Ç–∞–∫–æ–π –ø–æ–¥—Ö–æ–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–µ–¥–∫–æ. –ù–æ —Å–∞–º–∞ –∏–¥–µ—è ¬´–ª–µ–Ω–∏–≤–æ–≥–æ —Å–ø–∏—Å–∫–∞ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–π¬ª —ç–∫—Å–ø–ª—É–∞—Ç–∏—Ä—É–µ—Ç—Å—è –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —á–∞—Å—Ç–æ, –≤ —Ç–æ–º —á–∏—Å–ª–µ –∏ –¥–ª—è –±–µ—Å—Å—Ç–µ–∫–æ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–µ–∫—É—Ä—Å–∏–∏, –æ –∫–æ—Ç–æ—Ä–æ–π —Ä–∞—Å—Å–∫–∞–∂–µ–º –¥–∞–ª–µ–µ.



<anchor>trampolines</anchor>

#### –ë–∞—Ç—É—Ç—ã

–£ –∞–Ω–≥–ª–æ—è–∑—ã—á–Ω—ã—Ö –∫–æ–ª–ª–µ–≥ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π –∞—Å—Å–æ—Ü–∏–∏—Ä—É–µ—Ç—Å—è —Å –ø—Ä—ã–∂–∫–∞–º–∏ –Ω–∞ –±–∞—Ç—É—Ç–µ, –∫–æ–≥–¥–∞ –æ–¥–∏–Ω –ø—Ä—ã–∂–æ–∫ –ø–æ—Ä–æ–∂–¥–∞–µ—Ç –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ. –ü–æ —ç—Ç–æ–π –ø—Ä–∏—á–∏–Ω–µ —Å–ø–æ—Å–æ–± –∑–∞—â–∏—Ç—ã –æ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è —Å—Ç–µ–∫–∞ –ø–æ—Å—Ä–µ–¥—Å—Ç–≤–æ–º —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã—Ö —Ç–∏–ø–æ–≤ –Ω–æ—Å–∏—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ ¬´*trampoline*¬ª (–±–∞—Ç—É—Ç).

–ü–µ—Ä–≤—ã–º –ø—Ä–∏–º–µ—Ä–æ–º –ø–æ—Å–ª—É–∂–∏—Ç –æ–±–æ–±—â—ë–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä `TailRec` –∏–∑ –ø–∞–∫–µ—Ç–∞ [TailCalls](https://www.scala-lang.org/api/3.x/scala/util/control/TailCalls$.html) —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ Scala:
```scala
sealed abstract class TailRec[+A   ]{ ... }
protected case  class Call   [ A   ](rest: () => TailRec[A])            extends TailRec[A]
protected case  class Done   [ A   ](value: A)                          extends TailRec[A]
protected case  class Cont   [ A, B](a: TailRec[A], f: A => TailRec[B]) extends TailRec[B]
```
–í–∏–¥–Ω–æ, —á—Ç–æ –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –æ–Ω —Å–∏–ª—å–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞–µ—Ç `Freer`, –∏ —ç—Ç–æ –Ω–µ—Å–ø—Ä–æ—Å—Ç–∞. –ü–æ–∂–∞–ª—É–π, –≤—Å–µ —Ç—Ä–∞–º–ø–ª–∏–Ω—ã –æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –∏–∑–æ–º–æ—Ä—Ñ–Ω—ã —Ç–∞–∫–æ–º—É ¬´–±–æ–ª–µ–µ —Å–≤–æ–±–æ–¥–Ω–æ–º—É¬ª –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É:
```scala
type TrampolineBase[A] = () => A // TrampolineBase[A] ‚âÖ A¬π ‚âÖ A
type Trampoline[A] = Freer[TrampolineBase, A]
```
¬´–ë–∞–∑–∞¬ª —Ç—Ä–∞–º–ø–ª–∏–Ω–∞ `TrampolineBase[_]` –∏–∑–æ–º–æ—Ä—Ñ–Ω–∞ —Ç—Ä–∏–≤–∏–∞–ª—å–Ω–æ–º—É `Id[A] = A`, –Ω–æ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è —Å–µ–º–∞–Ω—Ç–∏–∫–æ–π ¬´–ª–µ–Ω–∏–≤–æ–≥–æ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è¬ª. –≠—Ç–æ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å —Å—Ä–∞–∑—É, –µ–≥–æ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å –∫–∞–∫ –∞—Ä–≥—É–º–µ–Ω—Ç –≤ –¥—Ä—É–≥—É—é —Ñ—É–Ω–∫—Ü–∏—é –∏ –ª–∏—à—å —Ç–∞–º –ø—Ä–∏–Ω—è—Ç—å —Ä–µ—à–µ–Ω–∏–µ, –∑–∞–ø—É—Å–∫–∞—Ç—å –ª–∏ –µ–≥–æ, –∏ —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑. `Freer` –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ä–∞–∑–º–µ—â–∞—Ç—å —Å–ø–∏—Å–æ–∫ –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π –≤ *–∫—É—á–µ*, –∫–æ—Ç–æ—Ä–∞—è –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –±–æ–ª—å—à–µ —á–µ–º —Å—Ç–µ–∫. –í –¥–∞–ª—å–Ω–µ–π—à–µ–º —ç—Ç–æ—Ç —Å–ø–∏—Å–æ–∫ –º–æ–∂–Ω–æ —Å–≤–µ—Ä–Ω—É—Ç—å —Å –ø–æ–º–æ—â—å—é –≤—Å—ë —Ç–æ–π –∂–µ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–Ω–æ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ö–≤–æ—Å—Ç–æ–≤–æ–π —Ä–µ–∫—É—Ä—Å–∏–∏.

–¢—Ä–∞–º–ø–ª–∏–Ω—ã —É–¥–æ–±–Ω—ã, –≤ —á–∞—Å—Ç–Ω–æ—Å—Ç–∏, –¥–ª—è –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –∫–æ—Å–≤–µ–Ω–Ω–æ–π —Ä–µ–∫—É—Ä—Å–∏–∏, –∫–æ—Ç–æ—Ä—É—é –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä –Ω–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –í–æ—Ç –ø—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `TailRec`:
```scala
import scala.util.control.TailCalls.*

val even: Int => TailRec[Boolean] =
  case 0 => done(true)
  case i => tailcall(odd(i - 1))

val odd: Int => TailRec[Boolean] =
  case 0 => done(false)
  case i => tailcall(even(i - 1))

even(1234567).result // true
```
–ü—Ä–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–∏ –º–µ—Ç–æ–¥–∞ `reult` —Ö–≤–æ—Å—Ç–æ–≤–∞—è —Ä–µ–∫—É—Ä—Å–∏—è –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç—Å—è –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–æ–º.

–ß–∞—â–µ –≤ –∫–∞—á–µ—Å—Ç–≤–µ –ø—Ä–∏–º–µ—Ä–∞ –±–∞—Ç—É—Ç–∞ –Ω–∞–∑—ã–≤–∞—é—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä `Eval[_]` [–∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ Cats](https://typelevel.org/cats/datatypes/eval.html). –û–Ω –∞–Ω–∞–ª–æ–≥–∏—á–µ–Ω `TailRec`, –Ω–æ –¥–æ–ø–æ–ª–Ω–µ–Ω —ç—Ñ—Ñ–µ–∫—Ç–æ–º ¬´–∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è¬ª (memoization), –ø–æ–∑–≤–æ–ª—è—é—â–∏–º –≤—ã—á–∏—Å–ª—è—Ç—å ¬´–∑–∞–ø–∞–∫–æ–≤–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ¬ª –ª–∏—à—å –ø—Ä–∏ *–ø–µ—Ä–≤–æ–π* —Ä–∞—Å–ø–∞–∫–æ–≤–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, —á—Ç–æ –Ω–∞–º —Å–µ–π—á–∞—Å –Ω–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∏–∑—É—á–µ–Ω–∏—è –±–∞—Ç—É—Ç–æ–≤. –í–æ—Ç –∫–∞–∫ –º–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å—Ç–µ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ —á–∏—Å–µ–ª –§–∏–±–æ–Ω–∞—á—á–∏ –ø–æ—Å—Ä–µ–¥—Å—Ç–≤–æ–º `Eval`:
```scala
def fib(n: Int, a: Long = 0, b: Long = 1): Eval[Long] =
  Eval.always(a + b)          // –ª–µ–Ω–∏–≤–æ–µ –≤—ã—á–∏–ª–µ–Ω–∏–µ
    .flatMap { b2 =>          // –∞–Ω–∞–ª–æ–≥ tailcall
      if (n > 0) fib(n - 1, b, b2)
      else       Eval.now(a)  // –∂–∞–¥–Ω–æ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã))
    }

fib(10).value // 55
```
–ú–æ–∂–µ—Ç –ø–æ–∫–∞–∑–∞—Ç—å—Å—è, —á—Ç–æ –≤—Å—è –º–∞–≥–∏—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ö–≤–æ—Å—Ç–æ–≤–æ–π —Ä–µ–∫—É—Ä—Å–∏–∏ –∑–∞–∫–ª—é—á–∞–µ—Ç—Å—è –∑–¥–µ—Å—å –≤ –Ω–∞–ª–∏—á–∏–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ `flatMap`. –ù–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è –Ω–µ —Ç–æ–ª—å–∫–æ –Ω–∞–ª–∏—á–∏–µ, –Ω–æ –∏ ¬´–ª–µ–Ω–∏–≤–æ—Å—Ç—å¬ª *–∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π* —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ `flatMap`, –∫–æ—Ç–æ—Ä–∞—è, –∫–∞–∫ –ø—Ä–∞–≤–∏–ª–æ, –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω–æ–≥–æ —Ç–∏–ø–∞.

–ü—Ä–æ–¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ–º —ç—Ç–æ –Ω–∞ –ø—Ä–∏–º–µ—Ä–µ —Ç–∞–∫–æ–π —Ñ—É–Ω–∫—Ü–∏–∏:
```scala
import cats.Moand
import cats.syntax.all.*

def tailRecM[F[_]: Monad, A, B](f: A => F[Either[A, B]]): A => F[B]
  = (a: A) => f(a)
	.flatMap(_.fold(
	  tailRecM(f), // —Ä–µ–∫—É—Ä—Å–∏—è
	  cats.Monad[F].pure
	))
```
–≠—Ç–æ —Ç–∏–ø–∏—á–Ω—ã–π —É–Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–Ω—ã–π –æ—Ç Haskell –º–µ—Ö–∞–Ω–∏–∑–º —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–µ–∫—É—Ä—Å–∏–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –º–æ–Ω–∞–¥–∏—á–µ—Å–∫–∏—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –Ω–µ–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ `F[_]`. –û–¥–Ω–∞–∫–æ —Ç–∞–∫–∞—è —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥–æ–π–¥—ë—Ç –≤–æ–≤—Å–µ –Ω–µ –¥–ª—è –ª—é–±–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:
```scala
def evenBase: Int => Either[Int, Boolean] = 
  case        0   => true   .asRight
  case        1   => false  .asRight
  case        x   => (x - 2).asLeft

def evenId   = tailRecM[  Id, Int, Boolean](         evenBase   ) 
def evenEval = tailRecM[Eval, Int, Boolean](Eval now evenBase(_))

evenEval(1234567).value // false
evenId  (1234567)       // StackOverflowException
```
¬´–õ–µ–Ω–∏–≤—ã–π¬ª `Eval` –æ—Ç—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –±–µ–∑ –ø—Ä–æ–±–ª–µ–º, —Ç–æ–≥–¥–∞ –∫–∞–∫ ¬´–∂–∞–¥–Ω–∞—è¬ª —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è `flatMap` –¥–ª—è `Id` –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—é —Å—Ç–µ–∫–∞. –û–¥–Ω–∞–∫–æ –º–µ—Ç–æ–¥ `tailRecM` –∏–∑ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π –≤ Cats —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–ª–∞—Å—Å–∞ —Ç–∏–ø–æ–≤ `Monad[Id]` —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –æ—à–∏–±–æ–∫:
```scala
Monad[Id].tailRecM(1234567)(evenBase) // false
```
–§–æ–∫—É—Å –≤ —Ç–æ–º, —á—Ç–æ `tailRecM` –∏–∑ `cats.Monad[Id]` —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –Ω–µ—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ, –∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ –¥–ª—è `Id`, —á–µ—Ä–µ–∑ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é —Ö–≤–æ—Å—Ç–æ–≤–æ–π —Ä–µ–∫—É—Ä—Å–∏–∏ (–∏ –∞–Ω–Ω–æ—Ç–∞—Ü–∏—é `@tailrec`). –í–ø—Ä–æ—á–µ–º, –≤ —ç—Ç–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–µ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º –∑–∞–ø–∏—Å–∞–Ω—ã `tailRecM` –∏ –¥–ª—è –¥—Ä—É–≥–∏—Ö —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤.

–°—Ç–æ–∏—Ç —É–ø–æ–º—è–Ω—É—Ç—å –µ—â—ë –æ–¥–Ω—É —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –±–∞—Ç—É—Ç–∞ –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ Cats.Effect ‚Äì –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã—Ö –ø–æ–±–æ—á–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ [IO](https://typelevel.org/cats-effect/docs/datatypes/io). –°–µ–∫—Ä–µ—Ç –µ–≥–æ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ—Å—Ç–∏ –∫–∞–∫ —Ä–∞–∑ –∏ –∑–∞–∫–ª—é—á–∞–µ—Ç—Å—è –≤ —Ç–æ–º, —á—Ç–æ –æ–Ω –ø–æ —Å—É—Ç–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π —Å–≤–æ–±–æ–¥–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, ¬´—á–∏—Å—Ç–æ¬ª –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—â–∏–π –≤ —Å–µ–±–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å ¬´—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–π¬ª. –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä `IO[_]` —Ç–∞–∫–∂–µ –∞–Ω–∞–ª–æ–≥–∏—á–µ–Ω –≤–≤–µ–¥—ë–Ω–Ω–æ–º—É —Ä–∞–Ω–µ–µ `Trampoline[_]`, –Ω–æ –¥–æ–ø–æ–ª–Ω–µ–Ω –º–Ω–æ–≥–æ—á–∏—Å–ª–µ–Ω–Ω—ã–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏. –í —á–∞—Å—Ç–Ω–æ—Å—Ç–∏, –≤ `IO` –≤—Å—Ç—Ä–æ–µ–Ω –º–µ—Ö–∞–Ω–∏–∑–º –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫, —á—Ç–æ –¥–µ–ª–∞–µ—Ç –µ–≥–æ –±–æ–ª—å—à–µ –ø–æ—Ö–æ–∂–∏–º –Ω–∞ —Ç–∞–∫–æ–π —Ç–∏–ø:
```scala
type IO[A] = Freer[[X] =>> () => Try[X], A]
```

–î–∞, `IO[_]` ‚Äì —ç—Ç–æ —Å–∞–º—ã–π –Ω–∞—Å—Ç–æ—è—â–∏–π —Å–≤–æ–±–æ–¥–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞–Ω –≤ –∫–æ–Ω—Ü–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –≤ –ª—é–±–æ–π –¥—Ä—É–≥–æ–π: `Id`, `Either`, `Future`, `ZI–û`‚Ä¶ –ï–≥–æ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –∫–∞—á–µ—Å—Ç–≤–µ –±–∞—Ç—É—Ç–∞ –ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏ —Å `Eval[_]`, –æ–±—Ä–∞—â–∞—è—Å—å –∫ –º–µ—Ç–æ–¥–∞–º `flatMap` –∏ `tailRecM`, –Ω–æ –ø–æ–∂–∞–ª—É–π —á–∞—â–µ –≤—Å–µ–≥–æ –≤ –ø—Ä–æ–¥—É–∫—Ç–æ–≤–æ–º –∫–æ–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–µ—Ç–æ–¥ `foreverM`:
```scala
extension [F[_]: Monad, A] (fa: F[A])
  def foreverM: F[Nothing] =
    Monad[F].tailRecM(())(_ => fa as Left(()))
```
–ú–µ—Ç–æ–¥ –∑–∞—Ü–∏–∫–ª–∏–≤–∞–µ—Ç —É–∫–∞–∑–∞–Ω–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç, —á—Ç–æ –±—ã–≤–∞–µ—Ç –ø–æ–ª–µ–∑–Ω–æ –ø—Ä–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –¥–µ–π—Å—Ç–≤–∏–π —á–µ—Ä–µ–∑ –∫–∞–∫–∏–µ-—Ç–æ –ø—Ä–æ–º–µ–∂—É—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ.


- [–ó–∞—á–µ–º –≤ Scala —Ç—Ä–∞–º–ø–ª–∏–Ω—ã –∏ –∫–∞–∫ –∏—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å / –•–∞–±—Ä](https://habr.com/ru/companies/kryptonite/articles/796433/) (–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è)
- [Taming Cats - Eval](https://plippe.github.io/blog/2018/12/01/taming-cats-eval.html) –≤ –±–ª–æ–≥–µ –ò—Ñ–ª–∏–ø–ø–∞ –•–æ–∑–∏-–í–∏–Ω—á–æ–Ω–∞
- [Tail Recursive Monads (FlatMap)](https://eed3si9n.com/herding-cats/tail-recursive-monads.html) (herding cats)
- [Stackless Scala With Free Monads](https://blog.higher-order.com/assets/trampolines.pdf)(pdf) —Å—Ç–∞—Ç—å—è –†—É–Ω–∞—Ä–∞ –ë—å—è—Ä–Ω–∞—Å–æ–Ω–∞ 
- [Stack Safety for Free](https://functorial.com/stack-safety-for-free/index.pdf) (pdf) —Å—Ç–∞—Ç—å—è –§–∏–ª–∞ –§—Ä–∏–º–∞–Ω–∞



<anchor>cofree</anchor>

#### –ö–æ-—Å–≤–æ–±–æ–¥–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

```scala
type CoFreeBase[F[_], A] = [X] =>> (A, F[X])
type Cofree[F[_]] = [A] =>> ùõé[CoFreeBase[F, A]]
```

```scala
def    pureCofree[F[_]: Lift, A] =  inFix[ùõé, CoFreeBase[F, A]]
def extractCofree[F[_]: Lift, A] = outFix[ùõé, CoFreeBase[F, A]]
```

##### –ü–ï–†–ï–ü–ò–°–ê–¢–¨ Lift[Cofree[F]] !!
```scala
given liftCofreeBase[F[_]: Lift, X]: Lift[CoFreeBase[F, X]] = 
[A, B] => (f: A => B) => ((attr: X, prev: F[A]) => attr -> prev.map(f)).tupled

given liftCofree[F[_]: Lift]: Lift[Cofree[F]] = 
[A, B] => (f: A => B) => (p: Cofree[F][A]) =>
  inFix[ùõé, CoFreeBase[F, B]]{
	val (a, fa) = outFix[ùõé, CoFreeBase[F, A]](p)
	(f(a), fa.map(fmap[Cofree[F]](f)))
  }
```

##### Comonad[Cofree]
##### –¢—ã–∫–≤—ë–Ω–æ–∫-Cofree ‚Äì —É–º–µ–µ—Ç —Ç–æ–ª—å–∫–æ —Ä–∞—Å—Ç–∏



<anchor>free_rec_schemes</anchor>

#### –•—Ä–æ–Ω–æ–º–æ—Ä—Ñ–∏–∑–º—ã

[[–í–æ–ø—Ä–æ—Å –ø—Ä–æ —Ö—Ä–æ–Ω–æ–º–æ—Ä—Ñ–∏–∑–º—ã]]


##### futumorphism



##### histomorphism
##### dynamomorphism



- [Histomorphism, Dynamorphism, Futumorphism](https://free.cofree.io/2017/11/13/recursion/#histomorphism) (Scala) –ë–ª–æ–≥ –¶–∑–∏—è–Ω–∞ –õ—é.
- [Recursion Schemes, Part IV: Time is of the Essence](http://blog.sumtypeofway.com/recursion-schemes-part-iv-time-is-of-the-essence/) (Haskell) –≤ –±–ª–æ–≥–µ –ü–∞—Ç—Ä–∏–∫–∞ –¢–æ–º–ø—Å–æ–Ω–∞
- [Time Traveling Recursion Schemes](https://jtobin.io/time-traveling-recursion)¬†(Haskell) –î–∂–∞—Ä–µ–¥ –¢–æ–±–∏–Ω.